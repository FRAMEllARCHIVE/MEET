<html><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MEET</title>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        font-family: Arial, sans-serif;
    }
    #canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: black;
    }
    #controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
    }
    button, input {
        background-color: rgba(255, 255, 255, 0);
        border: none;
        color: white;
        padding: 5px 10px;
        margin: 2px;
        cursor: pointer;
    }
    #chat-area {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 10px;
        box-sizing: border-box;
        opacity: 0.4;
    }
    #chat-messages {
        height: 100px;
        overflow-y: auto;
    }
    #message-input {
        width: calc(100% - 140px);
        background-color: rgba(255, 255, 255, 0.1);
    }
    #voip-btn {
        background-color: rgba(0, 255, 0, 0.2);
    }
    #voip-btn.active {
        background-color: rgba(255, 0, 0, 0.2);
    }
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="controls">
    <input type="color" id="color-picker" value="#ffffff">
    <button id="clear-btn">X</button>
    <button id="voip-btn">&#128266;</button>
    <button id="copy-peer-id-btn">&#x1F517;</button>
</div>
<div id="chat-area">
    <div id="chat-messages"></div>
    <input type="text" id="message-input" placeholder="Type a message...">
    <button id="send-btn">Send</button>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const colorPicker = document.getElementById('color-picker');
const clearBtn = document.getElementById('clear-btn');
const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const peerIdInput = document.getElementById('peer-id-input');
const connectBtn = document.getElementById('connect-btn');
const voipBtn = document.getElementById('voip-btn');

let isDrawing = false;
let lastX = 0;
let lastY = 0;
let localStream;
let isVoipActive = false;

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

canvas.addEventListener('mousedown', startDrawing);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', stopDrawing);
canvas.addEventListener('mouseout', stopDrawing);

function startDrawing(e) {
    isDrawing = true;
    [lastX, lastY] = [e.offsetX, e.offsetY];
}

function draw(e) {
    if (!isDrawing) return;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.strokeStyle = colorPicker.value;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.stroke();
    [lastX, lastY] = [e.offsetX, e.offsetY];
    broadcast({type: 'draw', x0: lastX, y0: lastY, x1: e.offsetX, y1: e.offsetY, color: colorPicker.value});
}

function stopDrawing() {
    isDrawing = false;
}

clearBtn.addEventListener('click', () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    broadcast({type: 'clear'});
});

const peer = new Peer();
let connections = [];

peer.on('open', (id) => {
    console.log('Your peer ID is: ' + id);
});

peer.on('connection', (conn) => {
    connections.push(conn);
    setupConnection(conn);
});

peer.on('call', (call) => {
    if (isVoipActive && localStream) {
        call.answer(localStream);
        setupVoipCall(call);
    }
});

function setupConnection(conn) {
    conn.on('data', (data) => {
        if (data.type === 'draw') {
            drawLine(data.x0, data.y0, data.x1, data.y1, data.color);
        } else if (data.type === 'clear') {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        } else if (data.type === 'chat') {
            addChatMessage(conn.peer, data.message);
        }
    });
}

function broadcast(data) {
    connections.forEach(conn => conn.send(data));
}

function drawLine(x0, y0, x1, y1, color) {
    ctx.beginPath();
    ctx.moveTo(x0, y0);
    ctx.lineTo(x1, y1);
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.stroke();
}

function addChatMessage(sender, message) {
    const messageElement = document.createElement('div');
    messageElement.textContent = `${sender}: ${message}`;
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

function sendMessage() {
    const message = messageInput.value.trim();
    if (message) {
        addChatMessage('You', message);
        broadcast({type: 'chat', message: message});
        messageInput.value = '';
    }
}

function hashHandler() {
    const hash = window.location.hash.substring(1);
    if (hash) {
        connectToPeer(hash);
    }
}

function connectToPeer(peerId) {
    const conn = peer.connect(peerId);
    connections.push(conn);
    setupConnection(conn);
}


window.addEventListener('load', hashHandler);
window.addEventListener('hashchange', hashHandler);

voipBtn.addEventListener('click', toggleVoip);

function toggleVoip() {
    if (isVoipActive) {
        stopVoip();
    } else {
        startVoip();
    }
}

function startVoip() {
    navigator.mediaDevices.getUserMedia({ audio: true, video: false })
        .then((stream) => {
            localStream = stream;
            isVoipActive = true;
            voipBtn.textContent = '&#128266;';
            voipBtn.classList.add('active');
            connections.forEach(conn => {
                const call = peer.call(conn.peer, stream);
                setupVoipCall(call);
            });
        })
        .catch((err) => console.error('Failed to get local stream', err));
}

function stopVoip() {
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    isVoipActive = false;
    voipBtn.textContent = 'Start VoIP';
    voipBtn.classList.remove('active');
}

function setupVoipCall(call) {
    call.on('stream', (remoteStream) => {
        const audio = new Audio();
        audio.srcObject = remoteStream;
        audio.play();
    });
}

const copyPeerIdBtn = document.getElementById('copy-peer-id-btn');

function copyPeerIdToClipboard() {
    const peerId = peer.id;
    const urlToCopy = `https://framellarchive.github.io/MEET/#${peerId}`;

    navigator.clipboard.writeText(urlToCopy).then(() => {
        console.log('Peer ID copied to clipboard:', urlToCopy);

        addChatMessage('System', 'Peer ID copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy: ', err);
    });
}

copyPeerIdBtn.addEventListener('click', copyPeerIdToClipboard);


</script>
</body>
</html>
